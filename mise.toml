[tools]
cosign = "latest"
go = "1.25.4"
goreleaser = "2.12.7"
ko = "0.18.0"
svu = "3.3.0"
yq = "4.49.2"

[env]
CGO_ENABLED = "0"
# Container registry settings
KO_DOCKER_REPO = "ghcr.io/markussiebert/homeddns"
# Build metadata
REPO_NAME = "markussiebert/homeddns"

[tasks.build]
description = "Build homeddns binary for current platform"
depends = ["fmt", "tidy"]
run = """
VERSION=$(tr -d '\n' < VERSION)
go build -trimpath -ldflags="-s -w -extldflags=-static -X github.com/${REPO_NAME}.buildVersion=${VERSION}" -o homeddns .
"""

[tasks."build:linux"]
description = "Build homeddns binary for Linux AMD64 (optimized)"
depends = ["fmt", "tidy"]
run = """
VERSION=$(tr -d '\n' < VERSION)
go build -trimpath -ldflags="-s -w -extldflags=-static -X github.com/${REPO_NAME}.buildVersion=${VERSION}" -tags netgo -installsuffix netgo -o homeddns-linux-amd64 .
"""
env = { GOOS = "linux", GOARCH = "amd64" }

[tasks."build:linux-arm"]
description = "Build homeddns binary for Linux ARM64 (optimized)"
depends = ["fmt", "tidy"]
run = """
VERSION=$(tr -d '\n' < VERSION)
go build -trimpath -ldflags="-s -w -extldflags=-static -X github.com/${REPO_NAME}.buildVersion=${VERSION}" -tags netgo -installsuffix netgo -o homeddns-linux-arm64 .
"""
env = { GOOS = "linux", GOARCH = "arm64" }

[tasks."build:ko"]
description = "Build container image with Ko (local)"
depends = ["test"]
run = """
export VERSION=$(tr -d '\n' < VERSION)
export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
ko build . --local --bare --sbom=none
"""
env = { KO_DOCKER_REPO = "ko.local" }

[tasks."build:ko-push"]
description = "Build and push container image with Ko (single platform)"
depends = ["test"]
run = """
VERSION=$(tr -d '\n' < VERSION)
ko build . --bare --sbom=none --tags="${VERSION},latest"
"""

[tasks."build:ko-multiplatform"]
description = "Build multi-platform container image with Ko"
depends = ["test"]
run = """
VERSION=$(tr -d '\n' < VERSION)
ko build . --bare --sbom=none --platform=linux/amd64,linux/arm64,linux/arm/v7 --tags="${VERSION},latest"
"""

[tasks.test]
description = "Run all tests"
run = "go test ./..."

[tasks."test:verbose"]
description = "Run all tests with verbose output"
run = "go test -v ./..."

[tasks."test:provider"]
description = "Test provider package only"
run = "go test ./internal/provider"

[tasks.fmt]
description = "Format Go code"
run = "go fmt ./..."

[tasks.tidy]
description = "Tidy go modules"
run = "go mod tidy"

[tasks.run]
description = "Run homeddns server (set env vars: AUTH_USERNAME, AUTH_PASSWORD_HASH, etc.)"
run = "go run main.go server"

[tasks."run:dev"]
description = "Run server with example netcup_ccp config (requires .env.local)"
run = "go run main.go server"
sources = [".env.local"]

[tasks."run:update"]
description = "Run update command (usage: mise run run:update -- <hostname>)"
run = "go run main.go update"

[tasks."build:size"]
description = "Show size comparison of built binaries"
run = "ls -lh homeddns* 2>/dev/null | awk '{print $5, $9}' || echo 'No binaries found. Run mise run build first.'"

[tasks.clean]
description = "Clean build artifacts"
run = "rm -rf homeddns homeddns-linux-* cdk-dynamic-dns dyndns *.tar dist/"

# CI/CD tasks
[tasks.ci]
description = "Run full CI pipeline (verify, test, build, validate)"
depends = ["tidy", "test", "build", "build:ko", "release:validate"]
run = """
echo "âœ… CI pipeline completed successfully"
echo ""
echo "Summary:"
echo "  - Dependencies verified and tidied"
echo "  - All tests passed"
echo "  - Binary built successfully"
echo "  - Ko image built locally"
echo "  - GoReleaser config validated"
"""

[tasks.dev]
description = "Run in development mode with auto-reload (requires watchexec)"
run = "watchexec -r -e go -- go run main.go server"
sources = [".env.local"]

# Release tasks
[tasks."release:validate"]
description = "Validate release configuration before publishing"
run = """
echo "Validating release configuration..."
goreleaser check
echo "âœ… GoReleaser config is valid"
"""

[tasks."release:snapshot"]
description = "Test full release locally without publishing"
depends = ["test", "release:validate"]
run = """
echo "Creating snapshot release (no publish)..."
goreleaser release --snapshot --clean --skip=publish,sign
echo "âœ… Snapshot build successful"
echo "Check ./dist/ for artifacts"
"""

[tasks."release:goreleaser"]
description = "Build and release cross-platform binaries with goreleaser"
depends = ["test", "release:validate"]
run = "goreleaser release --clean"

[tasks."release:ko"]
description = "Build and push multi-arch Ko images with auto-detected version"
depends = ["test"]
run = """
VERSION=$(tr -d '\n' < VERSION)
export VERSION
export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")

echo "Building Ko images for version: ${VERSION}"
ko build . \
  --bare \
  --sbom=none \
  --platform=linux/amd64,linux/arm64,linux/arm/v7 \
  --tags="${VERSION},latest"

echo "âœ… Images pushed:"
echo "  - ${KO_DOCKER_REPO}:${VERSION}"
echo "  - ${KO_DOCKER_REPO}:latest"
"""

[tasks."release:ko-with-version"]
description = "Build and push Ko images with specific version tag (for CI)"
depends = ["test"]
run = """
if [ -z "$VERSION_TAG" ]; then
  echo "Error: VERSION_TAG environment variable is required"
  exit 1
fi
export VERSION=$(echo "$VERSION_TAG" | sed 's/^v//')
export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")

echo "Building Ko images for version: ${VERSION}"
ko build . \
  --bare \
  --sbom=none \
  --platform=linux/amd64,linux/arm64,linux/arm/v7 \
  --tags="${VERSION},latest"

echo "âœ… Images pushed:"
echo "  - ${KO_DOCKER_REPO}:${VERSION}"
echo "  - ${KO_DOCKER_REPO}:latest"
"""

[tasks."release:ko-sign"]
description = "Sign Ko images with cosign"
depends = ["release:ko-with-version"]
run = """
VERSION=$(tr -d '\n' < VERSION)
echo "Signing images for version: ${VERSION}"

cosign sign --yes ${KO_DOCKER_REPO}:${VERSION}
cosign sign --yes ${KO_DOCKER_REPO}:latest

echo "âœ… Images signed with cosign"
"""

[tasks."release:ko-verify"]
description = "Verify Ko image signatures"
run = """
VERSION=$(tr -d '\n' < VERSION)
echo "Verifying image signature for version: ${VERSION}"

cosign verify \
  --certificate-identity-regexp="https://github.com/${REPO_NAME}" \
  --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
  ${KO_DOCKER_REPO}:${VERSION}

echo "âœ… Signature verified"
"""

[tasks."release:dry-run:ko"]
description = "Dry run: Build Ko image locally (for testing)"
run = """
echo "Testing Ko (local build)..."
export KO_DOCKER_REPO=ko.local
export VERSION=$(tr -d '\n' < VERSION)
export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
ko build . --local --bare --sbom=none
echo "âœ… Ko local build successful"
"""

[tasks."release:dry-run"]
description = "Dry run: test everything without publishing"
depends = ["test", "release:validate", "release:snapshot", "release:dry-run:ko"]
run = """
echo "âœ… Dry run complete - ready to release!"
echo ""
echo "Summary:"
echo "  - Tests passed"
echo "  - GoReleaser config validated"
echo "  - Snapshot release created (check ./dist/)"
echo "  - Ko local build successful"
"""

[tasks."release:check"]
description = "Verify published release artifacts"
run = """
VERSION=$(tr -d '\n' < VERSION)
echo "Checking release: v${VERSION}"
echo ""

# Check GitHub release
echo "ðŸ“‹ GitHub Release:"
gh release view "v${VERSION}" --json tagName,name,publishedAt,assets || echo "âŒ Not found"
echo ""

# Check container images
echo "ðŸ³ Container Images:"
docker pull ${KO_DOCKER_REPO}:${VERSION} && echo "âœ… Version tag exists" || echo "âŒ Not found"
docker pull ${KO_DOCKER_REPO}:latest && echo "âœ… Latest tag exists" || echo "âŒ Not found"
echo ""

echo "Use 'mise run release:ko-verify' to check signatures"
"""

[tasks."release:version"]
description = "Compute next semantic version using svu and update Home Assistant config"
run = """
VERSION=$(svu next)
VERSION_NO_V=${VERSION#v}
echo "$VERSION_NO_V" > VERSION
export VERSION=$VERSION_NO_V
yq eval -i '.version = strenv(VERSION)' homeassistant/config.yaml
echo "$VERSION"
"""


[tasks."release:version:patch"]
description = "Compute next patch version and update Home Assistant config"
run = """
VERSION=$(svu patch)
VERSION_NO_V=${VERSION#v}
echo "$VERSION_NO_V" > VERSION
export VERSION=$VERSION_NO_V
yq eval -i '.version = strenv(VERSION)' homeassistant/config.yaml
echo "$VERSION"
"""


[tasks."release:version:minor"]
description = "Compute next minor version and update Home Assistant config"
run = """
VERSION=$(svu minor)
VERSION_NO_V=${VERSION#v}
echo "$VERSION_NO_V" > VERSION
export VERSION=$VERSION_NO_V
yq eval -i '.version = strenv(VERSION)' homeassistant/config.yaml
echo "$VERSION"
"""


[tasks."release:version:major"]
description = "Compute next major version and update Home Assistant config"
run = """
VERSION=$(svu major)
VERSION_NO_V=${VERSION#v}
echo "$VERSION_NO_V" > VERSION
export VERSION=$VERSION_NO_V
yq eval -i '.version = strenv(VERSION)' homeassistant/config.yaml
echo "$VERSION"
"""

# Complete publish workflow task
[tasks.publish]
description = "Complete publish workflow: build binaries, containers, sign, and release"
depends = ["test", "release:validate", "release:goreleaser", "release:ko-with-version", "release:ko-sign"]
run = """
VERSION=$(cat VERSION)
echo ""
echo "âœ… Publish complete for v${VERSION}"
echo ""
echo "Summary:"
echo "  - Binaries released via GoReleaser"
echo "  - Container images built and pushed"
echo "  - Images signed with cosign"
echo ""
echo "Links:"
echo "  - GitHub Release: https://github.com/${REPO_NAME}/releases/tag/v${VERSION}"
echo "  - Container: ghcr.io/${REPO_NAME}:${VERSION}"
"""

# Complete release workflow task
[tasks.release]
description = "Complete release workflow: version, tag, and trigger publish"
run = """
# Determine version bump type from environment variable (default: next)
BUMP="${RELEASE_BUMP:-next}"

# Compute version based on bump type (svu returns vX.Y.Z)
case "$BUMP" in
  patch)
    VERSION_WITH_V=$(svu patch)
    ;;
  minor)
    VERSION_WITH_V=$(svu minor)
    ;;
  major)
    VERSION_WITH_V=$(svu major)
    ;;
  *)
    VERSION_WITH_V=$(svu next)
    ;;
esac

# Strip 'v' prefix for VERSION file and Home Assistant config
VERSION_NO_V=${VERSION_WITH_V#v}

echo "ðŸ“¦ Computed version: $VERSION_WITH_V (stored as $VERSION_NO_V)"

# Update VERSION file and Home Assistant config (without 'v' prefix)
echo "$VERSION_NO_V" > VERSION
export VERSION=$VERSION_NO_V
yq eval -i '.version = strenv(VERSION)' homeassistant/config.yaml

# Commit version changes
git config user.name "github-actions[bot]"
git config user.email "github-actions[bot]@users.noreply.github.com"
git add VERSION homeassistant/config.yaml
git diff --staged --quiet || git commit -m "chore: bump version to $VERSION_WITH_V"

# Push changes
git push origin HEAD

# Create and push tag (with 'v' prefix)
git tag "$VERSION_WITH_V"
git push origin "$VERSION_WITH_V"

echo ""
echo "âœ… Release $VERSION_WITH_V completed successfully"
echo ""
echo "ðŸ“‹ Tag pushed to origin, publish workflow will be triggered automatically"
echo ""
echo "Next steps:"
echo "  - Monitor the publish workflow: gh run list --workflow=publish.yml"
echo "  - Check GitHub releases page: https://github.com/${REPO_NAME}/releases/tag/$VERSION_WITH_V"
"""

