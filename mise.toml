[tools]
cosign = "latest"
go = "1.25.4"
goreleaser = "2.12.7"
ko = "0.18.0"
svu = "3.3.0"

[env]
CGO_ENABLED = "0"

[tasks.build]
description = "Build homeddns binary for current platform"
run = "version=$(tr -d '\n' < VERSION) && go build -trimpath -ldflags=\"-s -w -extldflags=-static -X github.com/markussiebert/homeddns.buildVersion=$version\" -o homeddns ."

[tasks."build:linux"]
description = "Build homeddns binary for Linux AMD64 (optimized)"
run = "version=$(tr -d '\n' < VERSION) && go build -trimpath -ldflags=\"-s -w -extldflags=-static -X github.com/markussiebert/homeddns.buildVersion=$version\" -tags netgo -installsuffix netgo -o homeddns-linux-amd64 ."
env = { GOOS = "linux", GOARCH = "amd64" }

[tasks."build:linux-arm"]
description = "Build homeddns binary for Linux ARM64 (optimized)"
run = "version=$(tr -d '\n' < VERSION) && go build -trimpath -ldflags=\"-s -w -extldflags=-static -X github.com/markussiebert/homeddns.buildVersion=$version\" -tags netgo -installsuffix netgo -o homeddns-linux-arm64 ."
env = { GOOS = "linux", GOARCH = "arm64" }

[tasks."build:ko"]
description = "Build container image with Ko (local)"
run = "VERSION=$(cat VERSION) ko build . --local --bare"
env = { KO_DOCKER_REPO = "ko.local" }

[tasks."build:ko-push"]
description = "Build and push container image with Ko"
run = "VERSION=$(cat VERSION) ko build . --bare"
env = { KO_DOCKER_REPO = "ghcr.io/markussiebert" }

[tasks."build:ko-multiplatform"]
description = "Build multi-platform container image with Ko"
run = "VERSION=$(cat VERSION) ko build . --bare --platform=linux/amd64,linux/arm64"
env = { KO_DOCKER_REPO = "ghcr.io/markussiebert" }

[tasks.test]
description = "Run all tests"
run = "go test ./..."

[tasks."test:verbose"]
description = "Run all tests with verbose output"
run = "go test -v ./..."

[tasks."test:provider"]
description = "Test provider package only"
run = "go test ./internal/provider"

[tasks.fmt]
description = "Format Go code"
run = "go fmt ./..."

[tasks.tidy]
description = "Tidy go modules"
run = "go mod tidy"

[tasks.run]
description = "Run homeddns server (set env vars: AUTH_USERNAME, AUTH_PASSWORD_HASH, etc.)"
run = "go run main.go server"

[tasks."run:dev"]
description = "Run server with example netcup_ccp config (requires .env.local)"
run = "go run main.go server"
sources = [".env.local"]

[tasks."run:update"]
description = "Run update command (usage: mise run run:update -- <hostname>)"
run = "go run main.go update"

[tasks."build:size"]
description = "Show size comparison of built binaries"
run = "ls -lh homeddns* 2>/dev/null | awk '{print $5, $9}' || echo 'No binaries found. Run mise run build first.'"

[tasks.clean]
description = "Clean build artifacts"
run = "rm -f homeddns homeddns-linux-* cdk-dynamic-dns dyndns *.tar"

[tasks.dev]
description = "Run in development mode with auto-reload (requires watchexec)"
run = "watchexec -r -e go -- go run main.go server"
sources = [".env.local"]

# Release tasks
[tasks."release:validate"]
description = "Validate release configuration before publishing"
run = """
echo "Validating release configuration..."
goreleaser check
echo "‚úÖ GoReleaser config is valid"
"""

[tasks."release:snapshot"]
description = "Test full release locally without publishing"
run = """
echo "Creating snapshot release (no publish)..."
goreleaser release --snapshot --clean --skip=publish,sign
echo "‚úÖ Snapshot build successful"
echo "Check ./dist/ for artifacts"
"""

[tasks."release:goreleaser"]
description = "Build and release cross-platform binaries with goreleaser"
run = "goreleaser release --clean"

[tasks."release:ko"]
description = "Build and push multi-arch Ko images with auto-detected version"
run = """
VERSION=$(cat VERSION | tr -d '\n')
export VERSION
export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")

echo "Building Ko images for version: ${VERSION}"
ko build . \
  --bare \
  --sbom=none \
  --platform=linux/amd64,linux/arm64,linux/arm/v7 \
  --tags="${VERSION},latest"

echo "‚úÖ Images pushed:"
echo "  - ghcr.io/markussiebert/homeddns:${VERSION}"
echo "  - ghcr.io/markussiebert/homeddns:latest"
"""
env = { KO_DOCKER_REPO = "ghcr.io/markussiebert/homeddns" }

[tasks."release:ko-with-version"]
description = "Build and push Ko images with specific version tag"
run = """
if [ -z "$VERSION_TAG" ]; then
  echo "Error: VERSION_TAG environment variable is required"
  exit 1
fi
export VERSION=$(echo "$VERSION_TAG" | sed 's/^v//')
export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")

echo "Building Ko images for version: ${VERSION}"
ko build . \
  --bare \
  --sbom=none \
  --platform=linux/amd64,linux/arm64,linux/arm/v7 \
  --tags="${VERSION},latest"

echo "‚úÖ Images pushed:"
echo "  - ghcr.io/markussiebert/homeddns:${VERSION}"
echo "  - ghcr.io/markussiebert/homeddns:latest"
"""
env = { KO_DOCKER_REPO = "ghcr.io/markussiebert/homeddns" }

[tasks."release:ko-sign"]
description = "Sign Ko images with cosign"
run = """
echo "Signing images for version: ${VERSION}"

cosign sign --yes ghcr.io/markussiebert/homeddns:${VERSION}
cosign sign --yes ghcr.io/markussiebert/homeddns:latest

echo "‚úÖ Images signed with cosign"
"""

[tasks."release:ko-verify"]
description = "Verify Ko image signatures"
run = """
VERSION=$(cat VERSION | tr -d '\n')
echo "Verifying image signature for version: ${VERSION}"

cosign verify \
  --certificate-identity-regexp="https://github.com/markussiebert/homeddns" \
  --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
  ghcr.io/markussiebert/homeddns:${VERSION}

echo "‚úÖ Signature verified"
"""

[tasks."release:dry-run"]
description = "Dry run: test everything without publishing"
depends = ["test", "release:validate"]
run = """
echo "üß™ DRY RUN: Testing release process..."
echo ""

# Test GoReleaser
echo "Testing GoReleaser (snapshot mode)..."
mise run release:snapshot
echo ""

# Test Ko locally
echo "Testing Ko (local build)..."
export KO_DOCKER_REPO=ko.local
export VERSION=$(cat VERSION | tr -d '\n')
export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
ko build . --local --bare
echo ""

echo "‚úÖ Dry run complete - ready to release!"
"""

[tasks."release:check"]
description = "Verify published release artifacts"
run = """
VERSION=$(cat VERSION | tr -d '\n')
echo "Checking release: v${VERSION}"
echo ""

# Check GitHub release
echo "üìã GitHub Release:"
gh release view "v${VERSION}" --json tagName,name,publishedAt,assets || echo "‚ùå Not found"
echo ""

# Check container images
echo "üê≥ Container Images:"
docker pull ghcr.io/markussiebert/homeddns:${VERSION} && echo "‚úÖ Version tag exists" || echo "‚ùå Not found"
docker pull ghcr.io/markussiebert/homeddns:latest && echo "‚úÖ Latest tag exists" || echo "‚ùå Not found"
echo ""

echo "Use 'mise run release:ko-verify' to check signatures"
"""

[tasks."release:version"]
description = "Compute next semantic version using svu"
run = "svu next"

[tasks."release:version:patch"]
description = "Compute next patch version"
run = "svu patch"

[tasks."release:version:minor"]
description = "Compute next minor version"
run = "svu minor"

[tasks."release:version:major"]
description = "Compute next major version"
run = "svu major"
