# Testing the Home Assistant Add-on Locally

This guide explains how to test the HomeDDNS add-on in your local Home Assistant installation.

## Prerequisites

- Home Assistant OS or Supervised installation
- SSH or Samba access to Home Assistant
- The add-on files in this directory

## Installation Steps

### 1. Access the `/addons` Directory

**Via SSH:**
```bash
ssh root@homeassistant.local
cd /addons
```

**Via Samba:**
- Connect to `\\homeassistant.local\addons` (Windows)
- Or `smb://homeassistant.local/addons` (macOS/Linux)

### 2. Create the Add-on Directory

```bash
mkdir -p local_homeddns
```

### 3. Copy Add-on Files

Copy all files from this `homeassistant/` directory to `/addons/local_homeddns/`:

```
/addons/local_homeddns/
  ├── config.yaml
  ├── Dockerfile
  ├── run.sh
  ├── README.md
  ├── DOCS.md
  ├── CHANGELOG.md
  └── translations/
      └── en.yaml
```

### 4. Reload Add-on Store

1. Open Home Assistant web interface
2. Go to **Settings** → **Add-ons**
3. Click the three-dot menu (⋮) in the top right
4. Select **Check for updates**
5. Refresh your browser (Ctrl+F5 / Cmd+Shift+R)

### 5. Install the Add-on

You should now see "HomeDDNS - Dynamic DNS Updater" under **Local add-ons**.

1. Click on the add-on
2. Click **Install**
3. Wait for the build to complete (this may take several minutes)

### 6. Generate Password Hash

Before configuring, generate a bcrypt password hash:

```bash
docker run --rm -i ghcr.io/markussiebert/homeddns:latest hash-password
# Type your password and press Enter
# Copy the hash (starts with $2a$10$...)
```

### 7. Configure the Add-on

Go to the **Configuration** tab and set:

**For Netcup:**
```yaml
auth_username: dyndns
auth_password_hash: "$2a$10$..." # Your generated hash
dns_provider: netcup_ccp
domain: example.com
dns_ttl: 60
port: 8080
netcup_customer_number: "123456"
netcup_api_key: "your-api-key"
netcup_api_password: "your-api-password"
```

**For AWS Route53:**
```yaml
auth_username: dyndns
auth_password_hash: "$2a$10$..." # Your generated hash
dns_provider: route53
domain: example.com
dns_ttl: 60
port: 8080
aws_access_key_id: "AKIAIOSFODNN7EXAMPLE"
aws_secret_access_key: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
aws_region: "us-east-1"
```

### 8. Start the Add-on

1. Click **Save** on the configuration
2. Go to the **Info** tab
3. Click **Start**
4. Check the **Log** tab for any errors

### 9. Test the Add-on

**Via Ingress (recommended):**
1. Click **Open Web UI** (if Ingress is working)

**Via Port:**
```bash
curl -u "dyndns:your-password" \
  "http://homeassistant.local:8080/nic/update?hostname=test.example.com&myip=1.2.3.4"
```

Expected response: `good 1.2.3.4`

## Troubleshooting

### Add-on doesn't show up

1. Check file permissions: `chmod +x /addons/local_homeddns/run.sh`
2. Verify `config.yaml` is valid YAML: `yamllint config.yaml`
3. Check Supervisor logs: **Settings** → **System** → **Logs** → Select "Supervisor"

### Build fails

1. Check Dockerfile syntax
2. Ensure the base image is accessible
3. Review build logs in the add-on page

### Add-on won't start

1. Check the **Log** tab for error messages
2. Verify all required configuration fields are set
3. Ensure password hash is valid (starts with `$2a$10$`)
4. Check that DNS provider credentials are correct

### Testing hash-password command

```bash
# Inside the add-on container
docker exec -it addon_local_homeddns /bin/bash
echo "testpass" | /usr/local/bin/homeddns hash-password
```

## Publishing the Add-on

Once testing is complete, you can publish the add-on by:

1. Creating a GitHub repository for the add-on
2. Following the [Home Assistant add-on repository structure](https://developers.home-assistant.io/docs/add-ons/repository)
3. Submitting to the Home Assistant community add-ons repository

## Development Workflow

### Quick Update Cycle

After making changes to the add-on files:

1. Copy updated files to `/addons/local_homeddns/`
2. Go to add-on page in Home Assistant
3. Click **Rebuild** (if available) or **Uninstall** → **Install**
4. Check logs for any errors

### Debugging

Enable debug logging by adding to `run.sh`:
```bash
set -x  # Enable bash debug mode
```

Check container logs:
```bash
docker logs addon_local_homeddns
```

## Next Steps

- Test with your actual router's DynDNS client
- Verify DNS records are updated correctly
- Test failover scenarios (network loss, API errors)
- Monitor resource usage over time
